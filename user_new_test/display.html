<!DOCTYPE html>
<html>
<!-- 这个文件好像没有用 和卫星界面显示基本一样的 -->
<head>
  <meta charset="utf-8" />
  <title>用户终端界面</title>
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="//cdn.bootcss.com/socket.io/1.5.1/socket.io.min.js"></script>
  <script type="text/javascript" charset="utf-8"></script>
  <style>
    #header {
      background-color: blue;
      color: white;
      text-align: center;
      padding: 5px;
    }

    #nav {
      line-height: 30px;
      background-color: #eeeeee;
      height: 300px;
      width: 925px;
      float: left;
      padding: 5px;
    }

    #section {
      width: 350px;
      float: left;
      padding: 10px;
    }

    #footer {
      background-color: black;
      color: white;
      clear: both;
      text-align: center;
      padding: 5px;
    }
  </style>
</head>

<body>

  <div id="header">
    <h1>用户终端界面</h1>
    <button onclick="send()">开始</button>
  </div>

  <div id="nav">
    <h2>请求<h2>
        <form>
          <p5 id="simple"> 这里将用于显示一些简要信息 </p5>
          <p5 id="simpleResult"> 并显示请求结果 </p5>
        </form>
  </div>

  <div id="section">
    <h2>详细请求</h2>

  </div>

  <div id="footer">
    用户终端日志
  </div>

  <label id="result">认证消息：</label>
  <div id='log'></div>
  <br><br>


  <script>
            function send() {
                // 通知用户发起认证
                var url = "http://127.0.0.1:8888/userAuth";
                $.get(url, function (data) {
                    if (data == "1") {
                        console.log("认证成功。。。");
                    } else {
                        console.log("认证失败。。。");
                    }
                })};
                </script>

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function () {
      var socket = io.connect();

socket.on('server_response', function (msg) {
        console.log(msg);
        if (msg.data.length != 0 && tmp != msg.data[0]) {
          change_tmp(msg.data)

          // $('#log').append('<br>' + $('<div/>').text('Received #' + ': ' + msg.data).html());
          $('#log').prepend('<br>' + $('<div/>').text('Received #' + ': ' + tmp).html());

          obj = JSON.parse(msg.data[0])
          console.log(obj)

          var simple = document.getElementById('simple');
          var simpleResult = document.getElementById('simpleResult');
          var details = document.getElementById('section');


          if (obj.Ru) {
            simple.innerHTML = "接收到用户:<br>" + obj.PIDu + "<br>发起的身份认证请求\n";
            simpleResult.innerHTML = "<br>正在进行转发处理 </h6>";
            time = fnDate();
            var toHTML = "<p6> 时间：" + time + "</p6><br>" + "<p6>用户信息:</p6><br>";
            for (var i in obj) {
              // alert(obj[i]);
              toHTML += "<p6>" + i + ":" + obj[i] + "</p6><br>"
            }
            details.innerHTML = toHTML;
          }
          else if (obj.userData) {
            simple.innerHTML = "正在转发用户:<br>\n" + obj.userData.PIDu + "<br>发起的身份认证请求\n";
            simpleResult.innerHTML = "<br>正在进行转发处理 </h6>";
            time = fnDate();
            var toHTML = "<p6> 时间：" + time + "</p6><br>" + "<p6>用户信息:</p6><br>";
            for (var i in obj.userData) {
              // alert(obj[i]);
              toHTML += "<p6>" + i + ":" + obj.userData[i] + "</p6><br>"
            }
            toHTML += "<p6>卫星信息:</p6><br>"
            for (var i in obj.satalliteData) {
              // alert(obj[i]);
              toHTML += "<p6>" + i + ":" + obj.satalliteData[i] + "</p6><br>"
            }
            details.innerHTML = toHTML;
          }
          else if (obj.ReqAuth == "ReqUserInfo") {
            simple.innerHTML = "正在向NCC请求用户:<br>" + obj.PIDu + "<br>的身份信息\n";
            simpleResult.innerHTML = "<br></h6>";
            time = fnDate();
            var toHTML = "<p6> 时间：" + time + "</p6><br>" + "<p6>请求用户信息:</p6><br>";
            for (var i in obj) {
              // alert(obj[i]);
              toHTML += "<p6>" + i + ":" + obj[i] + "</p6><br>"
            }
            details.innerHTML = toHTML;
          }

          else if (obj.ReqAuth == "200") {
            // simple.innerHTML = "正在向NCC请求用户\n" + obj.PIDu + "<br>的身份信息\n";
            simple.innerHTML = "用户:<br>" + obj.PIDu + "<br>认证成功<br>正在向用户返回成功认证消息";
            simpleResult.innerHTML = "<br></h6>";
            time = fnDate();
            var toHTML = "<p6> 时间：" + time + "</p6><br>" + "<p6>返回用户信息:</p6><br>";
            for (var i in obj) {
              // alert(obj[i]);
              toHTML += "<p6>" + i + ":" + obj[i] + "</p6><br>"
            }
            details.innerHTML = toHTML;
          }

          //错误处理
          else if (obj.ReqAuth == "500") {
            simple.innerHTML = "用户:<br>" + obj.PIDu + "<br>认证失败";
            simpleResult.innerHTML = "</h6>";
          }
        }
      });
      function fnDate() {
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth();
        var data = date.getDate();
        var hours = date.getHours();
        var minute = date.getMinutes();
        var second = date.getSeconds();
        var time = year + "-" + fnW((month + 1)) + "-" + fnW(data) + " " + fnW(hours) + ":" + fnW(minute) + ":" + fnW(second);
        return time;
      }
      function fnW(str) {
        var num;
        str > 10 ? num = str : num = "0" + str;
        return num;
      }
      // 改变全局变量tmp的值
      function change_tmp(data) {
        $.ajax({
          async: false,
          success: function () {
            tmp = data;
          }
        })
      }

    });
    

  </script>

</body>

</html>
